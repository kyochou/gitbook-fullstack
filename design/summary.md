# Design

## 秒杀系统
秒杀系统本质上就是一个满足大并发, 高性能和高可用的分布式系统.
秒杀就是同时处理大量的并发读和并发写.

### 架构原则 
如果你是一个架构师, 你首先要勾勒出一个轮廓, 想一想如何构建一个超大流量并发读写, 高性能, 以及高可用的系统, 这其中有哪些要素需要考虑.

* 数据要尽量少

    在网络间传输的数据(请求和回应)能少就少. 
    应用之间的调用能少就少.
    数据越简单, 越小越好.
    数据的压缩, 编码, 序列化等操作都是 CPU 杀手.
    
* 请求数要尽量少

    合并静态文件.
    减少 DNS 解析耗时.
    
* 路径要尽量短

    所谓 "路径", 就是用户发出请求到返回数据这个过程中, 需要经过的中间节点数(服务端调用).
    一种解决方法是将多个相互强依赖的应用合并部署, 把远程过程调用(RPC) 变成 JVM 内部之间的方法调用.
    
* 依赖要尽量少

    所谓依赖, 指的是要完成一次用户请求必须依赖的系统或服务.
    可以给系统进行分级, 保证高优先级的系统不会被低优先级的系统拖跨.    

* 不要有单点

    单点意味着没有备份, 风险不可控. 我们设计分布式系统最重要的原则就是 "消除单点". 
    避免单点的关键是避免将服务的状态和机器绑定, 即把服务无状态化(保护幂等性).
    像存储这类的服务本身很难无状态化. 因为数据要存储在磁盘上, 本身就要和机器绑定, 那么这种场景一般要通过冗余多个备份的方式来解决单点问题.
    
    
**架构是一种平衡的艺术, 最好的架构一旦脱离了它所适应的场景, 一切都将是空谈**.    
要取得极致的性能, 就要在其他方面(如通用性, 易用性, 成本等)有所牺牲.

### 动静分离
动静分离的目标有:
1. 提高单次请求的效率.
2. 减少没必要的请求.

所谓 "动静分离", 其实就是把用户请求的数据划分为 "动态数据" 和 "静态数据".
简单来说, "动态数据" 或 "静态数据" 的主要区别就是看页面中输出的数据是否和 URL, 浏览者, 时间, 地域相关, 以及是否含有 Cookie 等私密数据. 即是否含有和访问者相关的个性化数据.
分离了动静数据, 我们就可以对分离出来的静态数据做缓存, 有了缓存之后, 静态数据的 "访问效率" 自然就提高了.
如何对静态数据做缓存:
1. 你应该把静态数据缓存到离用户最近的地方.

    常见的缓存点有三种: 用户浏览器, CDN 和服务器 Cache. 你应该根据情况, 把它们尽量缓存到离用户最近的地方.

1. 静态化改造就是要直接缓存 HTTP 连接而不是仅仅缓存数据.
2. 让谁来缓存静态数据也很重要. 不同语言写的 Cache 软件处理缓存数据的效率也各不相同.

如何做动静分离:
1. URL 唯一化.
2. 分离浏览者相关的因素. 将个性化数据单独处理.
3. 分离时间因素.
4. 异步化地域因素.
5. 去除缓存数据中的 Cookie.

动态内容的处理通常有两种: ESI(Edge Side Includes) 方案和 CSI(Client Side Include)方案.
1. ESI, SSI: 即在 Web 代理服务器上做动态内容请求, 并将请求插入到静态页面中, 当用户拿到页面时已经是一个完整的页面了. 这种方式对服务端性能有些影响, 但是用户体验较好.
2. CSI: 即单独发起一个异步 JavaScript 请求, 以向服务端获取动态内容. 这种方式服务端性能更佳, 但用户端页面可能会延时, 体验稍差.

动静分离的几种架构方案:
1. 实体机单机部署.
2. 统一 Cache 层.
    Cache 最重要的一个衡量指标就是 "高命中率", 不然 Cache 的存在就失去了意义.
1. 上 CDN.
    在 CDN 上, 我们可以主动更新数据, 而在用户的浏览器里就很难控制了.
    将静态数据缓存到 CDN 的二级 Cache 上比较合适, 因为二级 Cache 数量偏少, 容量也更大. 让用户的请求先回源到 CDN 的二级 Cache 中, 如果没命中再回源到服务器获取数据.
    使用 CDN 的二级 Cache 作为缓存, 可以达到和当前服务端静态化 Cache 类似的命中率, 因为节点数不多, Cache 不是很分散, 访问量也比较集中, 这样也就解决了命中率问题, 同时能够给用户最好的访问体验, 是当前比较理想的一种 CDN 化方案.

### 二八原则 
热点分为 "操作热点" 和 "数据热点".
所谓 "静态热点数据", 就是能够提前预测的热点数据. 而所谓 "动态热点数据", 就是不能被提前预测到的, 系统在运行过程中临时产生的热点.

#### 发现静态热点数据
1. 通过一个运营系统, 把参加活动的商品数据进行打标, 然后通过一个后台系统对这些热点商品进行预处理.
2. 对买家每天访问的商品进行大数据计算, 然后统计出热点商品.

#### 发现动态热点数据





























